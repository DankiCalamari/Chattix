{% extends "base.html" %}
{% block content %}
<div class="sidebar">
    <img src="https://img.icons8.com/?size=100&id=3U2UjBX_nP9w&format=png&color=000000" alt="message icon" class="sidebar-logo">
    <h1 class="sidebar-title">Chattrix</h1>
    <div class="chath2">
        <h2>Chat Room</h2>
    </div>
    <a class="logout" href="{{ url_for('logout') }}">Logout</a>
    <button id="darkModeToggle">ðŸŒ™ Dark Mode</button>
    <ul id="onlineUsers"></ul>
</div>
<div class="main-content">
    <div id="messages"></div>
    <form id="messageForm">
        <input type="text" id="msgInput" placeholder="Type your message..." required>
        <input type="submit" value="Send">
    </form>
</div>

<script>
// Initialize socket.io
const socket = io();
const messageContainer = document.getElementById('messages');

// Notify server when user joins
socket.emit('user_joined');

/**
 * Adds a message to the message container.
 * Handles normal, system, and whisper messages.
 */
function addMessage(data) {
    const div = document.createElement('div');
    if (data.whisper) {
        div.classList.add('whisper-message');
        div.innerHTML = `<em>Whisper from <strong>${data.display_name}</strong> to <strong>${data.to}</strong>: ${data.text} <small>(${data.timestamp})</small></em>`;
    } else if (data.system) {
        div.classList.add('system-message');
        div.innerHTML = `<em>${data.text}</em>`;
    } else {
        div.innerHTML = `<strong>${data.display_name}</strong>: ${data.text} <small>(${data.timestamp})</small>`;
    }
    messageContainer.appendChild(div);
}

/**
 * Loads previous messages from the server and displays them.
 */
function loadMessages() {
    fetch('/messages')
        .then(res => res.json())
        .then(data => {
            messageContainer.innerHTML = '';
            data.forEach(msg => addMessage(msg));
            // Scroll to bottom after loading messages
            messageContainer.scrollTop = messageContainer.scrollHeight;
        });
}

/**
 * Handles new incoming messages from the server.
 */
socket.on('new_message', (data) => {
    addMessage(data);
    // Always scroll to bottom when a new message arrives
    messageContainer.scrollTop = messageContainer.scrollHeight;
});

/**
 * Handles form submission for sending messages.
 * Supports whisper command: /w username message
 */
document.getElementById('messageForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const input = document.getElementById('msgInput');
    const value = input.value.trim();

    // Whisper command: /w username message
    if (value.startsWith('/w ')) {
        const parts = value.split(' ');
        const toUsername = parts[1];
        const message = parts.slice(2).join(' ');
        socket.emit('whisper', { to: toUsername, text: message });
    } else {
        socket.emit('send_message', { text: value });
    }
    input.value = '';
});

/**
 * Handles incoming whisper messages.
 */
socket.on('whisper', (data) => {
    addMessage({ ...data, whisper: true });
});

/**
 * Updates the online users list in the sidebar.
 */
socket.on('online_users', function(users) {
    const userList = document.getElementById('onlineUsers');
    userList.innerHTML = '';
    users.forEach(function(name) {
        const li = document.createElement('li');
        li.textContent = name;
        userList.appendChild(li);
    });
});

// Load old messages on page load
loadMessages();





</script>
{% endblock %}
